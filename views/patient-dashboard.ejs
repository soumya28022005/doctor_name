<%- include('partials/header.ejs') %>

<div class="dashboard-header">
    <h1>Welcome, <%= patient.name %></h1>
    <p>Find doctors and book your appointments.</p>
</div>

<div class="dashboard-grid">
    <!-- Doctor Search -->
    <div class="card">
        <h3>Find a Doctor</h3>
        <div class="form-group">
            <input type="text" id="doctorNameSearch" onkeyup="searchDoctors()" placeholder="Search by name...">
        </div>
        <div class="form-group">
            <input type="text" id="specialtySearch" onkeyup="searchDoctors()" placeholder="Search by specialty (e.g., Dentist)...">
        </div>
        <div class="form-group">
            <input type="text" id="clinicSearch" onkeyup="searchDoctors()" placeholder="Search by clinic name or place...">
        </div>
        <div class="form-group">
            <label>Select Date to See Availability</label>
            <input type="date" id="dateSearch" onchange="searchDoctors()">
        </div>
        <div id="doctorSearchResults" style="margin-top: 20px;"></div>
    </div>

    <!-- Patient Appointments -->
    <div class="card">
        <h3>Your Appointments</h3>
        <ul class="appointment-list">
            <% if(appointments.length > 0) { %>
                <% appointments.forEach(app => { %>
                    <li class="appointment-item">
                        <strong>Dr. <%= app.doctorName %></strong> 
                        on <%= app.date %> at <%= app.time %><br>
                        Your Queue #: <strong><%= app.queueNumber %></strong><br>
                        <span class="queue-status" data-doctor-id="<%= app.doctorId %>">
                            Loading status...
                        </span>
                    </li>
                <% }) %>
            <% } else { %>
                <p>You have no appointments scheduled.</p>
            <% } %>
        </ul>
    </div>
</div>

<script>
    // Set date input to today by default
    document.getElementById('dateSearch').value = new Date().toISOString().slice(0, 10);

    async function searchDoctors() {
        const name = document.getElementById('doctorNameSearch').value;
        const specialty = document.getElementById('specialtySearch').value;
        const clinic = document.getElementById('clinicSearch').value;
        const date = document.getElementById('dateSearch').value;
        const resultsContainer = document.getElementById('doctorSearchResults');

        if (!date) {
            resultsContainer.innerHTML = '<p style="color:red;">Please select a date to see availability.</p>';
            return;
        }

        let query = [`date=${date}`];
        if (name) query.push(`name=${name}`);
        if (specialty) query.push(`specialty=${specialty}`);
        if (clinic) query.push(`clinic=${clinic}`);

        const response = await fetch(`/api/doctors?${query.join('&')}`);
        const doctors = await response.json();

        resultsContainer.innerHTML = '';
        if (doctors.length > 0) {
            doctors.forEach(doctor => {
                const doctorDiv = document.createElement('div');
                doctorDiv.className = 'appointment-item';
                doctorDiv.innerHTML = `<h4>${doctor.name} - ${doctor.specialty}</h4>`;
                
                doctor.schedules.forEach(schedule => {
                    let bookingFormHTML = `<p><b>${schedule.clinic.name}</b> (${schedule.startTime} - ${schedule.endTime})</p>`;
                    
                    // No time select, only Book button
                    bookingFormHTML += `
                    <form action="/book-appointment" method="POST">
                        <input type="hidden" name="patientId" value="<%= patient.id %>">
                        <input type="hidden" name="doctorId" value="${doctor.id}">
                        <input type="hidden" name="clinicId" value="${schedule.clinicId}">
                        <input type="hidden" name="date" value="${date}">
                        <button type="submit" class="btn">Book Appointment</button>
                    </form>`;

                    doctorDiv.innerHTML += bookingFormHTML;
                });
                resultsContainer.appendChild(doctorDiv);
            });
        } else {
            resultsContainer.innerHTML = '<p>No doctors found with the specified criteria.</p>';
        }
    }

    async function updateQueueStatus() {
        const statusElements = document.querySelectorAll('.queue-status');
        statusElements.forEach(async (el) => {
            const doctorId = el.dataset.doctorId;
            const response = await fetch(`/api/queue-status/${doctorId}`);
            const data = await response.json();
            el.innerHTML = `Live Status: <strong>Serving # ${data.currentNumber}</strong> (of ${data.totalPatients} total)`;
        });
    }

    // Initial load and periodic update
    document.addEventListener('DOMContentLoaded', () => {
        updateQueueStatus();
        setInterval(updateQueueStatus, 10000);
    });
</script>

<%- include('partials/footer.ejs') %>
