<%- include('partials/header.ejs') %>

<h1>Welcome, <%= admin.name %> (Admin)</h1>

<div class="dashboard-grid">
    <div class="card">
        <h3>Clinics</h3>
        <input type="text" id="clinicSearch" onkeyup="filterList('clinicSearch', 'clinicList')" placeholder="Search for clinics.." class="form-block" style="width: 100%; margin-bottom: 1rem;">
        <ul id="clinicList" class="appointment-list" style="max-height: 300px; overflow-y: auto;">
            <% clinics.forEach(c => { %>
                <li class="appointment-item">
                     <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong><%= c.name %></strong> - <%= c.address %><br><strong>Phone:</strong> <%= c.phone %><br>
                            <% const receptionist = receptionists.find(r => r.clinicId === c.id); %>
                            <% if (receptionist) { %>
                                <small>Receptionist: <%= receptionist.name %> | User: <%= receptionist.username %> | Pass: <%= receptionist.password %></small>
                            <% } else { %>
                                <small style="color: #ef4444;">No receptionist assigned.</small>
                            <% } %>
                        </div>
                        <form action="/admin/delete-clinic" method="POST" style="display:inline;">
                            <input type="hidden" name="clinicId" value="<%= c.id %>">
                            <input type="hidden" name="adminId" value="<%= admin.id %>">
                            <button type="submit" class="btn btn-danger btn-small">Delete</button>
                        </form>
                    </div>
                </li>
            <% }) %>
        </ul>
        <h4 style="margin-top: 2rem;">Add New Clinic</h4>
        <form action="/admin/add-clinic" method="POST" class="form-block">
            <input type="hidden" name="adminId" value="<%= admin.id %>">
            <input type="text" name="name" placeholder="Clinic Name" required>
            <input type="text" name="address" placeholder="Address" required>
            <input type="text" name="phone" placeholder="Phone" required>
            <hr style="margin: 1rem 0;">
            <label><strong>Create Receptionist Account for this Clinic:</strong></label>
            <input type="text" name="receptionistName" placeholder="Receptionist's Full Name" required>
            <input type="text" name="username" placeholder="Receptionist's Username" required>
            <input type="password" name="password" placeholder="Create Password" required>
            <button type="submit" class="btn" style="margin-top: 1rem;">Add Clinic & Receptionist</button>
        </form>
    </div>

    <div class="card">
        <h3>Doctors</h3>
        <input type="text" id="doctorSearch" onkeyup="filterList('doctorSearch', 'doctorList')" placeholder="Search for doctors.." class="form-block" style="width: 100%; margin-bottom: 1rem;">
        <ul id="doctorList" class="appointment-list" style="max-height: 300px; overflow-y: auto;">
            <% doctors.forEach(d => { %>
                <li class="appointment-item">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong><%= d.name %></strong> - <%= d.specialty %><br><strong>Phone:</strong> <%= d.phone %><br>
                            <small>User: <%= d.username %> | Pass: <%= d.password %></small>
                        </div>
                        <form action="/admin/delete-doctor" method="POST" style="display:inline;">
                            <input type="hidden" name="doctorId" value="<%= d.id %>">
                            <input type="hidden" name="adminId" value="<%= admin.id %>">
                            <button type="submit" class="btn btn-danger btn-small">Delete</button>
                        </form>
                    </div>
                </li>
            <% }) %>
        </ul>
        <h4 style="margin-top: 2rem;">Add New Doctor</h4>
        <form action="/admin/add-doctor" method="POST" class="form-block">
            <input type="hidden" name="adminId" value="<%= admin.id %>">
            <input type="text" name="name" placeholder="Doctor Name" required>
            <input type="text" name="specialty" placeholder="Specialty" required>
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <input type="number" name="dailyLimit" placeholder="Daily Patient Limit" required>

            <div style="margin-top: 1rem;">
                <label><strong>Assign to Existing Clinics:</strong></label><br>
                <% clinics.forEach(c => { %>
                    <div class="form-block">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: normal;">
                            <input type="checkbox" name="clinicIds" value="<%= c.id %>"> <%= c.name %>
                        </label>
                        <label>Start Time</label>
                        <input type="time" name="startTime_<%= c.id %>" >
                        <label>End Time</label>
                        <input type="time" name="endTime_<%= c.id %>" >
                        <input type="text" name="days_<%= c.id %>" placeholder="e.g., Monday, Wednesday">
                    </div>
                <% }) %>
            </div>

            <div style="margin-top: 1rem;" id="private-clinics-container">
                <label><strong>Or, Add Private Practice Locations:</strong></label>
                <div class="clinic-entry form-block" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; align-items: stretch;">
                    <input type="text" name="customAddress" placeholder="Private Practice Address" style="flex-grow: 1; width: 100%;">
                    <label>Start Time</label>
                    <input type="time" name="customStartTime" >
                    <label>End Time</label>
                    <input type="time" name="customEndTime" >
                    <input type="text" name="customDays" placeholder="e.g., Monday, Wednesday" style="width: 100%;">
                </div>
            </div>
            <button type="button" id="add-clinic-btn" class="btn btn-secondary btn-small" style="margin-bottom: 1rem;">+ Add Another Clinic</button>

            <button type="submit" class="btn" style="margin-top: 1rem; width: 100%;">Add Doctor</button>
        </form>
    </div>

    <div class="card">
        <h3>Patients</h3>
        <input type="text" id="patientSearch" onkeyup="filterList('patientSearch', 'patientList')" placeholder="Search for patients.." class="form-block" style="width: 100%; margin-bottom: 1rem;">
        <ul id="patientList" class="appointment-list" style="max-height: 300px; overflow-y: auto;">
            <% patients.forEach(p => { %>
                <li class="appointment-item">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong><%= p.name %></strong><br><strong>Phone:</strong> <%= p.phone %><br>
                            <small>User: <%= p.username %> | Pass: <%= p.password %></small>
                        </div>
                        <form action="/admin/delete-patient" method="POST" style="display:inline;">
                            <input type="hidden" name="patientId" value="<%= p.id %>">
                            <input type="hidden" name="adminId" value="<%= admin.id %>">
                            <button type="submit" class="btn btn-danger btn-small">Delete</button>
                        </form>
                    </div>
                </li>
            <% }) %>
        </ul>
        <h4 style="margin-top: 2rem;">Add New Patient</h4>
        <form action="/admin/add-patient" method="POST" class="form-block">
            <input type="hidden" name="adminId" value="<%= admin.id %>">
            <input type="text" name="name" placeholder="Patient Name" required>
            <input type="date" name="dob" required>
            <input type="text" name="mobile" placeholder="Mobile" required>
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit" class="btn">Add Patient</button>
        </form>
    </div>
    

    <div class="card">
        <h3>Today's Appointments</h3>
        <table>
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Doctor</th>
                    <th>Time</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <% 
                const today = new Date().toISOString().slice(0, 10);
                const todaysAppointments = appointments.filter(a => a.date === today);
                %>
                <% if(todaysAppointments.length > 0) { %>
                    <% todaysAppointments.forEach(a => { %>
                        <tr>
                            <td><%= a.patientName %></td>
                            <td><%= a.doctorName %></td>
                            <td><%= a.time %></td>
                            <td><%= a.status %></td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr><td colspan="4">No appointments today.</td></tr>
                <% } %>
            </tbody>
        </table>
        
        <h4 style="margin-top: 2rem;">Add Appointment (Admin)</h4>
        <form action="/admin/add-appointment" method="POST" class="form-block">
             <input type="hidden" name="adminId" value="<%= admin.id %>">
             <select name="patientId" required>
                <% patients.forEach(p => { %>
                    <option value="<%= p.id %>"><%= p.name %></option>
                <% }) %>
             </select>
             <select name="doctorId" required>
                <% doctors.forEach(d => { %>
                    <option value="<%= d.id %>"><%= d.name %></option>
                <% }) %>
             </select>
             <select name="clinicId" required>
                <% clinics.forEach(c => { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
             </select>
             <input type="date" name="date" required>
             <input type="time" name="time" required>
             <button type="submit" class="btn">Add Appointment</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const addClinicBtn = document.getElementById('add-clinic-btn');
    if (addClinicBtn) {
        addClinicBtn.addEventListener('click', function() {
            const container = document.getElementById('private-clinics-container');
            const newEntry = document.createElement('div');
            newEntry.className = 'clinic-entry form-block';
            newEntry.style.display = 'flex';
            newEntry.style.flexDirection = 'column';
            newEntry.style.gap = '10px';
            newEntry.style.marginBottom = '10px';
            newEntry.style.alignItems = 'stretch';
            
            newEntry.innerHTML = `
                <input type="text" name="customAddress" placeholder="Another Private Practice Address" style="flex-grow: 1; width: 100%;">
                <label>Start Time</label>
                <input type="time" name="customStartTime" >
                <label>End Time</label>
                <input type="time" name="customEndTime" >
                <input type="text" name="customDays" placeholder="e.g., Monday, Wednesday" style="width: 100%;">
                <button type="button" class="btn btn-danger btn-small remove-clinic-btn">Remove</button>
            `;
            container.appendChild(newEntry);

            newEntry.querySelector('.remove-clinic-btn').addEventListener('click', function() {
                newEntry.remove();
            });
        });
    }
});

function filterList(inputId, listId) {
    const input = document.getElementById(inputId);
    const filter = input.value.toLowerCase();
    const ul = document.getElementById(listId);
    const li = ul.getElementsByTagName('li');

    for (let i = 0; i < li.length; i++) {
        const txtValue = li[i].textContent || li[i].innerText;
        if (txtValue.toLowerCase().indexOf(filter) > -1) {
            li[i].style.display = "";
        } else {
            li[i].style.display = "none";
        }
    }
}
</script>

<%- include('partials/footer.ejs') %>

