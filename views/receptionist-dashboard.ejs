<%- include('partials/header.ejs') %>

<div class="dashboard-header">
    <h1>Welcome, <%= receptionist.name %> (Receptionist)</h1>
    <p>Managing <%= clinic.name %> - <%= clinic.address %></p>
</div>

<div class="dashboard-grid">
    <% if (joinRequests && joinRequests.length > 0) { %>
    <div class="card" style="background: #fffbeb; border-left: 4px solid #f59e0b;">
        <h3>Doctor Join Requests (<%= joinRequests.length %>)</h3>
        <ul class="appointment-list">
            <% joinRequests.forEach(req => { %>
                <li class="appointment-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <div style="flex-grow: 1;">
                            <strong>Dr. <%= req.doctorName %></strong> (<%= req.doctorSpecialty %>) wants to join.<br>
                            <small>Proposed Schedule: <%= req.schedule.startTime %> - <%= req.schedule.endTime %> on <%= req.schedule.days %></small>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                            <form action="/receptionist/handle-join-request" method="POST">
                                <input type="hidden" name="requestId" value="<%= req.id %>">
                                <input type="hidden" name="receptionistId" value="<%= receptionist.id %>">
                                <input type="hidden" name="action" value="accept">
                                <button type="submit" class="btn btn-success btn-small">Accept</button>
                            </form>
                            <form action="/receptionist/handle-join-request" method="POST" onsubmit="return confirm('Are you sure you want to delete this request?');">
                                <input type="hidden" name="requestId" value="<%= req.id %>">
                                <input type="hidden" name="receptionistId" value="<%= receptionist.id %>">
                                <input type="hidden" name="action" value="delete">
                                <button type="submit" class="btn btn-danger btn-small">Delete</button>
                            </form>
                        </div>
                    </div>
                </li>
            <% }) %>
        </ul>
    </div>
    <% } %>

    <div class="card">
        <h3>Add Doctor to <%= clinic.name %></h3>

        <div class="form-group" style="display: flex; gap: 20px;">
            <label style="font-weight: normal;"><input type="radio" name="addDoctorOption" value="new" checked onchange="toggleDoctorForm()"> Add New Doctor</label>
            <label style="font-weight: normal;"><input type="radio" name="addDoctorOption" value="existing" onchange="toggleDoctorForm()"> Invite Existing Doctor</label>
        </div>

        <!-- Add New Doctor Form -->
        <form id="newDoctorForm" action="/receptionist/add-doctor" method="POST">
            <input type="hidden" name="receptionistId" value="<%= receptionist.id %>">
            <div class="form-group">
                <label for="name">Doctor's Full Name</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="specialty">Specialty</label>
                <input type="text" id="specialty" name="specialty" required>
            </div>
            <div class="form-group">
                <label for="username">Create Username</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Create Password</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group">
                <label for="startTime">Start Time</label>
                <input type="time" id="startTime" name="startTime" required>
            </div>
            <div class="form-group">
                <label for="endTime">End Time</label>
                <input type="time" id="endTime" name="endTime" required>
            </div>

             <div class="form-group">
                <label for="Phonenumber">Phonenumber: </label>
                <input type="number" id="Phonenumber" name="Phonenumber" required>
            </div>
            
            <hr>
            <p><strong>Select Weekly Schedule:</strong></p>
            <div class="form-group">
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 5px;">
                    <label><input type="checkbox" class="day-checkbox" name="days" value="Sunday"> Sunday</label>
                    <label><input type="checkbox" class="day-checkbox" name="days" value="Monday"> Monday</label>
                    <label><input type="checkbox" class="day-checkbox" name="days" value="Tuesday"> Tuesday</label>
                    <label><input type="checkbox" class="day-checkbox" name="days" value="Wednesday"> Wednesday</label>
                    <label><input type="checkbox" class="day-checkbox" name="days" value="Thursday"> Thursday</label>
                    <label><input type="checkbox" class="day-checkbox" name="days" value="Friday"> Friday</label>
                    <label><input type="checkbox" class="day-checkbox" name="days" value="Saturday"> Saturday</label>
                </div>
                <div style="margin-top: 10px;">
                    <label style="font-weight: bold; color: #007bff;">
                        <input type="checkbox" id="select-all-days"> Every Day
                    </label>
                </div>
            </div>

            <p style="text-align: center; font-weight: bold; margin: 1rem 0;">OR</p>

            <div class="form-group">
                <label for="customSchedule"><strong>Enter Custom Schedule Rule:</strong></label>
                <input type="text" id="customSchedule" name="customSchedule" class="form-control" placeholder="e.g., 1st week of month">
            </div>
            <button type="submit" class="btn">Add Doctor</button>
        </form>

        <!-- Invite Existing Doctor Form -->
        <form id="existingDoctorForm" action="/receptionist/invite-doctor" method="POST" style="display: none;">
            <input type="hidden" name="receptionistId" value="<%= receptionist.id %>">

            <div class="form-group">
                <label for="doctorUsernameSearch">Search Doctor by Username</label>
                <input type="text" id="doctorUsernameSearch" onkeyup="filterDoctorOptions()" class="form-control" placeholder="Enter username...">
            </div>

            <div class="form-group">
                <label for="doctorId">Select Doctor</label>
                <select id="doctorId" name="doctorId" required>
                    <option value="">-- Please select a doctor --</option>
                    <% allDoctors.forEach(doctor => { %>
                        <option value="<%= doctor.id %>" data-username="<%= doctor.username.toLowerCase() %>">
                            <%= doctor.name %> (Username: <%= doctor.username %>)
                        </option>
                    <% }) %>
                </select>
            </div>
            
            <div class="form-group">
                <label for="inviteStartTime">Start Time</label>
                <input type="time" id="inviteStartTime" name="startTime" required>
            </div>
            <div class="form-group">
                <label for="inviteEndTime">End Time</label>
                <input type="time" id="inviteEndTime" name="endTime" required>
            </div>
            <div class="form-group">
                <label for="Phonenumber">Phonenumber: </label>
                <input type="number" id="Phonenumber" name="Phonenumber" required>
            </div>

            <hr>
            <p><strong>Select Weekly Schedule:</strong></p>
            <div class="form-group">
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 5px;">
                    <label><input type="checkbox" class="day-checkbox-invite" name="days" value="Sunday"> Sunday</label>
                    <label><input type="checkbox" class="day-checkbox-invite" name="days" value="Monday"> Monday</label>
                    <label><input type="checkbox" class="day-checkbox-invite" name="days" value="Tuesday"> Tuesday</label>
                    <label><input type="checkbox" class="day-checkbox-invite" name="days" value="Wednesday"> Wednesday</label>
                    <label><input type="checkbox" class="day-checkbox-invite" name="days" value="Thursday"> Thursday</label>
                    <label><input type="checkbox" class="day-checkbox-invite" name="days" value="Friday"> Friday</label>
                    <label><input type="checkbox" class="day-checkbox-invite" name="days" value="Saturday"> Saturday</label>
                </div>
                <div style="margin-top: 10px;">
                    <label style="font-weight: bold; color: #007bff;">
                        <input type="checkbox" id="select-all-days-invite"> Every Day
                    </label>
                </div>
            </div>

            <p style="text-align: center; font-weight: bold; margin: 1rem 0;">OR</p>

            <div class="form-group">
                <label for="inviteCustomSchedule"><strong>Enter Custom Schedule Rule:</strong></label>
                <input type="text" id="inviteCustomSchedule" name="customSchedule" class="form-control" placeholder="e.g., 1st week of month">
            </div>

            <button type="submit" class="btn">Send Invite</button>
        </form>
    </div>

    <div class="card">
        <h3>Doctors Available at <%= clinic.name %> (<%= doctors.length %>)</h3>
        <input type="text" id="doctorSearch" onkeyup="filterList('doctorSearch', 'doctorList')" placeholder="Search doctor by name..." class="form-block" style="width: 100%; margin-bottom: 1rem;">
        
        <ul id="doctorList" class="appointment-list">
            <% if(doctors.length > 0 || (typeof invitations !== 'undefined' && invitations.length > 0)) { %>
                <% doctors.forEach(doc => { %>
                    <li class="appointment-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex-grow: 1;">
                                <a href="/receptionist/doctor-appointments/<%= doc.id %>?receptionistId=<%= receptionist.id %>" style="text-decoration: none; color: inherit;">
                                    <strong><%= doc.name %></strong>
                                </a> 
                                (<%= doc.specialty %>)<br>
                                <small>Schedule: <%= doc.schedule.startTime %> - <%= doc.schedule.endTime %></small><br>
                                <small>Days: <%= doc.schedule.days %></small>
                            </div>
                            <form action="/receptionist/delete-doctor" method="POST" onsubmit="return confirm('Are you sure you want to delete this doctor? This action cannot be undone.');">
                                <input type="hidden" name="doctorId" value="<%= doc.id %>">
                                <input type="hidden" name="receptionistId" value="<%= receptionist.id %>">
                                <button type="submit" class="btn btn-danger btn-small">Delete</button>
                            </form>
                        </div>
                    </li>
                <% }) %>

                <% if(typeof invitations !== 'undefined') { %>
                    <% invitations.forEach(inv => { %>
                        <% const invitedDoctor = allDoctors.find(d => d.id === inv.doctorId); %>
                        <% if (invitedDoctor) { %>
                            <li class="appointment-item">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex-grow: 1;">
                                        <strong><%= invitedDoctor.name %></strong> (<%= invitedDoctor.specialty %>)
                                        <span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-left: 10px;">
                                            Pending
                                        </span>
                                        <br>
                                        <small>Invited Schedule: <%= inv.schedule.startTime %> - <%= inv.schedule.endTime %> on <%= inv.schedule.days %></small> 
                                    </div>
                                </div>
                            </li>
                        <% } %>
                    <% }) %>
                <% } %>
            <% } else { %>
                <p>No doctors assigned to <%= clinic.name %>.</p>
            <% } %>
        </ul>
    </div>
</div>

<script>
    document.getElementById('select-all-days').addEventListener('change', function(event) {
        const isChecked = event.target.checked;
        document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = isChecked);
    });

    document.getElementById('select-all-days-invite').addEventListener('change', function(event) {
        const isChecked = event.target.checked;
        document.querySelectorAll('.day-checkbox-invite').forEach(cb => cb.checked = isChecked);
    });

    function toggleDoctorForm() {
        const option = document.querySelector('input[name="addDoctorOption"]:checked').value;
        document.getElementById('newDoctorForm').style.display = (option === 'new') ? 'block' : 'none';
        document.getElementById('existingDoctorForm').style.display = (option === 'existing') ? 'block' : 'none';
    }

    function filterList(inputId, listId) {
        const filter = document.getElementById(inputId).value.toLowerCase();
        const items = document.getElementById(listId).getElementsByTagName('li');
        for (let i = 0; i < items.length; i++) {
            const txtValue = items[i].textContent || items[i].innerText;
            items[i].style.display = (txtValue.toLowerCase().indexOf(filter) > -1) ? "" : "none";
        }
    }

    function filterDoctorOptions() {
        const filter = document.getElementById('doctorUsernameSearch').value.toLowerCase();
        const options = document.getElementById('doctorId').getElementsByTagName('option');
        for (let i = 0; i < options.length; i++) {
            const username = options[i].getAttribute('data-username');
            if (username) {
                options[i].style.display = (username.indexOf(filter) > -1) ? "" : "none";
            }
        }
    }
</script>

<%- include('partials/footer.ejs') %>
